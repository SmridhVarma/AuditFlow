name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  deploy-services:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: router
            directory: services/router
          - service: rag
            directory: services/rag
          - service: agent
            directory: services/agent
          - service: reporter
            directory: services/reporter
          - service: frontend
            directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy ${{ matrix.service }}
        run: |
          cd ${{ matrix.directory }}
          railway up --service ${{ matrix.service }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  health-check:
    runs-on: ubuntu-latest
    needs: deploy-services
    steps:
      - name: Wait for services to start
        run: sleep 60

      - name: Check service health
        run: |
          echo "Deployment complete! Check Railway dashboard for service URLs."
          echo "Frontend: https://auditflow-frontend.up.railway.app"
